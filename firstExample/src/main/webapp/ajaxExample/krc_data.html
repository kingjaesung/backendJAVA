<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Insert title here</title>
<link href="../image/icon.png" rel="icon" type="image/x-icon" />

<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
	rel="stylesheet" />
<!-- integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous" -->
<style>
#item-template {
	display: none;
}

#map {
	height: 500px;
}
</style>
</head>
<body>
	<h3 class="text-center mb-2">한국농어촌공사에서 제공하는 계절 테마여행 세부 코스정보</h3>
	<div class="p-5 text-center bg-body-tertiary rounded-3">
		<div id="map"></div>
	</div>
	</div>
	<div class="container">
		<div id="list" class="row row-cols-1 row-cols-md-3 g-4">
			<div id="item-template" class="col">
				<div class="card">
					<img class="card-img-top">
					<div class="card-body">
						<h5 class="card-title fw-bold"></h5>
						<p class="card-text"></p>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	<script type="text/javascript"
		src="//dapi.kakao.com/v2/maps/sdk.js?appkey=2960d8c0e768f16e486a5885605f53d8"></script>
	<script>
		const template = function(no, destinationName, photoFile, lat, lng, address) {
			let $div = $('#list'); //카드들이 들어갈 영역
			
			let $element = $('#item-template').clone().removeAttr('id').show();
			// 템플릿 복제해서 사용
			
			$element.find('.card-img-top').attr({
				"src": photoFile,	//카드 이미지 넣기
				"data-lat" : lat,	//좌표 정도(위도) 저장
				"data-lng" : lng	//좌표 정보(경도) 저장
			});
		
		
		$element.find('.card-title').html(destinationName); // 코스명
		$element.find('.card-text').html(address); //주소
		
		$div.append($element); // list에 추가해서 화면에 표시
	}
		
	//지도 생성 및 마커 표시 함수
	
	function initMap(lat, lng){
		const container = document.getElementById('map');
		const options = {
				center: new kakao.maps.LatLng(lat, lng), //지도 중심 좌표
				level: 5								//줌 레벨(5면 어느정도 시야)
		};
		
		const map = new kakao.maps.Map(container, options); //지도 생성
		
		// 지도 오른쪽 위에 지도/스카이뷰 전환 버튼 추가
		
		let mapTypeControl = new kakao.maps.MapTypeControl();
		map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);
		
		// 지도 오른쪽에 확대/축소 컨트롤 추가
		let zoomControl = new kakao.maps.ZoomControl();
		map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);
		
		//전달받은 이치에 마커 표시
		let marker = new kakao.maps.Marker({
			position: map.getCenter()
		});
		marker.setMap(map);
	}
	
	//~~~~~~~~~~~~~~~AJAX로 JSON 데이터 읽고 카드 생성~~~~~~~~~~~~~~~~~
	$.ajax({
		url: '/firstExample/ajax/json/krc_data.json', //서버에 있는 JSON 파일 위치
		method: 'get',
		dataType: 'json'		//받아올 파일이 JSON임을 명시
	}).done(function(json){
		//받아온 데이터(json)는 배열 형태라서 반복문 처럼 처리
		$(json).each(function(index) {
			if(index <= 21) { //22개까지만 출력
				let no = this.no;				//번호
				let destinationName = this.destinationName; //여행지 이름 
				let photoFile = this.photoFile;	// 사진경로
				let lat = this.latitude;		// 위도
				let lng = this.longitude;		// 경도
				let address = this.address;		// 주소
				
				//위 값들을 사용해서 카드(HTML) 생성 및 목록에 추가
				template(no, destinationName, photoFile, lat, lng, address);
			}
		});
	}).fail(function(xhr, textStatus){
		//파일을 못 불러오거나 에러시 경고
		alert(textStatus + "(HTTP-" + xhr.status + ")");
		// xhr = 요청객체 (응답 상태 코드 등 정보를 담고 있음)
		// textStatus: 에러타입 (ex) timeout,error 등)
	});
	
	//---- 카드 이미지 클릭하면 해당 위치로 지도 이동
	$(document).on("click", ".card-img-top", function(){
		//card-img-top클래스를 가진 요소(카드이미지)가 동적으로 생성 되어도
		//클릭 이벤트가 잘 작동하게 document에 위임해서 설정
		// $(".card-img-top").on...으로 설정하면 지금 있는 클래스만 설정되고
		// 이후 만들어지는 클래스들에겐 적용 안됌
		let lat = $(this).data("lat");
		let lng = $(this).data("lng");
		//클릭한 이미지 태그에 저장된 data-lat와 data-lng값을 가져오는 코드
		// .data()는 jQuery가 HTML5 data- 속성을 쉽게 가져오게 한다
		console.log(lat, lng);
		initMap(lat, lng);
	});
	
		</script>
</body>
</html>